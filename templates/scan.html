<!DOCTYPE html>
<html lang="en">

{{template "head.html"}}

<body>
    {{template "nav.html"}}
<!--
    <div class="container">
        <div class="row">
            <div class="col-md-12" style="text-align: center;margin-bottom: 20px;">
                <div id="reader" style="display: inline-block;"></div>
                <div class="empty"></div>
                <div id="scanned-result"></div>
            </div>
        </div>
    </div>
-->
    <div class="container justify-content-center align-items-center text-center w-80 h-50 pt-3">
            <div class="" id="reader" ></div>
    </div>
    <hr class="justify-content-center hr" style="width: 85%;">
    <div class="justify-content-center align-items-center text-center">
        <button id="start" class="btn btn-success">Start Scanning.</button>
   </div>

    <hr class="justify-content-center hr pt-0" style="width: 85%;">
    <div class="pl-3 pt-2 textcolmob justify-content-center wipfooter align-items-center deskhide">
        <p class="deskhide descriptiontitle">How to scan a QR code:</p>
        <p class="deskhide description">Press "Start Scanning" and aim the camera at the QR code on the tree.</p>
    </div>
  {{template "mobnav.html"}}








  
    {{template "scripts.html"}}
    <script>
        var navTitle = '{{.navtitle}}';
        document.getElementById('navtitle').innerHTML = navTitle;
        document.getElementById('navtitle2').innerHTML = navTitle;
    </script>
    <script src="/static/js/html5-qrcode.min.js"></script>
    <script>
        var scanning = false;
        var scanningRequested = false;
        var html5qrcode = new Html5Qrcode("reader", true);

        function docReady(fn) {
            // see if DOM is already available
            if (document.readyState === "complete" || document.readyState === "interactive") {
                // call on next available tick
                setTimeout(fn, 1);
            } else {
                document.addEventListener("DOMContentLoaded", fn);
            }
        }

        function validURL(str) {
        var pattern = new RegExp('^(https?:\\/\\/)?'+ // protocol
            '((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.)+[a-z]{2,}|'+ // domain name
            '((\\d{1,3}\\.){3}\\d{1,3}))'+ // OR ip (v4) address
            '(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*'+ // port and path
            '(\\?[;&a-z\\d%_.~+=-]*)?'+ // query string
            '(\\#[-a-z\\d_]*)?$','i'); // fragment locator
        return !!pattern.test(str);
        }

        function startScanning() {
            console.log("Scan beginning")
            var results = document.getElementById('scanned-result');
            var lastMessage;
            var codesFound = 0;

            function onScanSuccess(qrCodeMessage) {
                var button = document.getElementById('start');
                if (lastMessage !== qrCodeMessage) {
                    lastMessage = qrCodeMessage;
                    if (validURL(qrCodeMessage)) {
                        stopScanning();
                        scanning = false;
                        button.disabled = false;
                        button.innerHTML = "Start Scanning";
                        button.setAttribute('class','btn btn-success');
                        //alert('This code is taking you to another page');
                        window.location.href = qrCodeMessage;
                    }
                }
            }
            return html5qrcode.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: 150 },
                onScanSuccess);
        }

        function stopScanning() {
            return html5qrcode.stop();
        }

        docReady(function() {
            var button = document.getElementById('start');
            button.addEventListener('click', function() {
                if (!scanning) {
                    button.disabled = true;
                    startScanning()
                    .then(_ => {
                        scanning = true;
                        button.disabled = false;
                        button.innerHTML = "Stop Scanning";
                        button.setAttribute('class','btn btn-danger')
                    })
                    .catch(err => {
                        button.disabled = false;
                        alert(err);
                    })
                } else {
                    button.disabled = true;
                    stopScanning()
                    .then(_ => {
                        scanning = false;
                        button.disabled = false;
                        button.innerHTML = "Start Scanning";
                        button.setAttribute('class','btn btn-success');
                    })
                    .catch(err => {
                        button.disabled = false;
                        alert(err);
                    }) 
                }
            });
        });
        </script>
</body>
{{template "footer.html"}}