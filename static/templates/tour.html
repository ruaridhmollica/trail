<!DOCTYPE html>
<html lang="en">

{{template "head.html"}}

<body>
    <!-- Imports the desktop navbar template -->
    {{template "nav.html"}}

    <!--<div class="pl-3 pt-4 textcol justify-content-center wipfooter d-flex align-items-center mobhide deskhide">
        <p class="mobhide"></p>
    </div>-->

    <!--The div for the map to be-->
    <div class="justify-content-center pt-0" id="map2"></div>


    <!-- Imports the modal for tree description -->
    {{template "infomodal.html"}}
    <!-- Imports the mobile navbar template -->
    {{template "mobnav.html"}}



    {{template "scripts.html"}}

    <script>
        //this small section of code updates the page heading to match the page a user is on e.g. TOUR. or MAP.
        var navTitle = '{{.navtitle}}';
        document.getElementById('navtitle').innerHTML = navTitle;
        document.getElementById('navtitle2').innerHTML = navTitle;
    </script>



    <script>
    //this script handles the event in which a user scanned a QR code of a tree
    //the qr variable is assigned a value of TRUE in the backend golang code. This value
    // allows the following modal cration code to be run
    var qr = '{{.qr}}';
    
    //if a user has scanne dthe QR code then the page will have loaded with special variables containing tree information pulled from the database
    //this information is then put into javascript variables where it can be placed into html elements in a modal and displayed
    if (qr){
        $('#myModal').modal('hide');
        qr = false;
        var id = '{{.id}}';
        var name = '{{.treename}}';
        var latinname = '{{.latinname}}';
        var height = '{{.height}}';
        var age = '{{.age}}';
        var description = '{{.description}}';
        var origin = '{{.origin}}';
        var img = '{{.img}}';
        $('#tree_title').html(id + ": " + name);
        $('#tree_img').attr("src", img);
        $('#tree_age').html(age);
        $('#latin_name').html(latinname);
        $('#tree_height').html(height);
        $('#tree_info').html(description);
        $('#tree_origin').html(origin);
        $('#myModal').modal('show');
    };

    </script>

    <!--Generate the map for the page using the Google My Maps JavaScript API-->
    <script>
        let map;
        let time;
        var visited = 0;

        //defines the variable used to convert text into speech (speech synth api)
        var textToSpeech = window.speechSynthesis;

        //kickstarts the obtaining of a users current location
        getLocation();

    //this piece of code is called when a trees geofence is entered, it displays the corresponding tree information in a modal
    function geofence (json){
        //this if statement makes sure to not run this code before a geofence is entered
        if (visited != 0){
            $('#myModal').modal('hide');
            var id = json.id;
            var name = json.name;
            var latinname = json.latinname;
            var height = json.height;
            var age = json.age;
            var description = json.description;
            var origin = json.origin;
            var img = json.img;
            $('#myModal').modal('hide');
            $('#tree_title').html(id + ": " + name);
            $('#tree_img').attr("src", img);
            $('#tree_age').html(age);
            $('#latin_name').html(latinname);
            $('#tree_height').html(height);
            $('#tree_info').html(description);
            $('#tree_origin').html(origin);
            $('#myModal').modal('show');
        }
    };

    //this function is called once a geofence is entered and uses the speech synth api to tell a user about the tree they are approaching.
    function speech(json){
        if (visited != 0){
            var id = json.id;
            var name = json.name;
            var latinname = json.latinname;
            var height = json.height;
            var age = json.age;
            var description = json.description;
            var origin = json.origin;

            if('speechSynthesis' in window){
                var speech = new SpeechSynthesisUtterance('You are approaching tree number' + id + '. This ' + latinname + '. commonly known as the' + name + '. is ' + height + ' feet tall. ' + age + 'years old. and originates from ' + origin + '.' + description);
                speech.lang = 'en-GB';
                textToSpeech.speak(speech);
            }
        }
    }
        //returns to the user an error messaged based on a received error code
        const getPositionError = code => {
            switch (code) {
                case 1:
                    return 'Permission denied, you may have to enable geolocation in your device settings.';
                case 2:
                    return 'Position unavailable.';
                case 3:
                    return 'Timeout reached.';
            }
        };
        //error handling for geolocation methods
        function showError(error)
            {
            switch(error.code) 
                {
                case error.PERMISSION_DENIED:
                x.innerHTML="User denied the request for Geolocation."
                break;
                case error.POSITION_UNAVAILABLE:
                x.innerHTML="Location information is unavailable."
                break;
                case error.TIMEOUT:
                x.innerHTML="The request to get user location timed out."
                break;
                case error.UNKNOWN_ERROR:
                x.innerHTML="An unknown error occurred."
                break;
                }
            };

        //checks if geolocation is enabled and supported in the users browser
        const getCurrentPosition = ({ onSuccess, onError = () => { } }) => {
            if ('geolocation' in navigator === false) {
                return onError(new Error('Sorry, Geolocation is not supported by your browser.'));
            }
            return navigator.geolocation.getCurrentPosition(onSuccess, onError);
        };

        //checks if a users location can be tracked and if this feature is supported by browser, if it is then it calls
        //the "watchposition" method that updates every time a user's location changes
        const trackLocation = ({ onSuccess, onError = () => { } }) => {
            if ('geolocation' in navigator === false) {
                return onError(new Error('Sorry, Geolocation is not supported by your browser.'));
            }

            return navigator.geolocation.watchPosition(onSuccess, onError, {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            });
        };

        //this is function gets the location every 3 secods so as to not timeout on location requests, it then calls the function that checks
        //if a user is inside a geofence or not
        function getLocation(){
                if (navigator.geolocation)
                    {
                    navigator.geolocation.getCurrentPosition(checkGeofence,showError);
                    setTimeout(getLocation, 3000);
                    }
                else{alert("Geolocation is not supported by this browser.");}
            };

        //this is the primary function used to speak to the backend and determine whether a user is inside a geofence.
        //it passes the latitude and longitude of a users current location to the backend via an AJAX post method.
        //the visited variable is the tree ID and is used to prevent the same tree being returned repeatedly when a user is inside the geofence
        //Tree data is returned as Json via a struct created in the golang code. The json is then parsed into a Javascript object that can be
        //indexed to obtain values. This obejct is passed to the function that displays the data and the speech synth function
        //If a user is not inside a geofence, or the geofence has already been visited, the string NULL is returned. This keep the connection "alive"
        //and allowed for easier error handling
        function checkGeofence(position){
            lat=position.coords.latitude;
            lng=position.coords.longitude;
            var i = 0;
            $.ajax({
                            url: "https://www.thetrailapp.com/geofence/" + lat + "/" + lng + "/" + visited,
                            method: "POST",
                            contentType:'application/json&apos',
                            dataType: 'json',
                            cache: false,
                            scriptCharset: 'utf-8',
                        }). done (function (jdata) {
                           var data = $.parseJSON(jdata);
                           //alert(data);

                            if(data == "null"){
                                console.log("Not in Geofence");
                            }else{
                                visited = data.id;
                                geofence(data);
                                speech(data);
                            }
                            i++;

                        }). fail (function (jdata) {
                            var d = $.parseJSON(jdata);
                            alert("fail");
                            console.log (jdata);
                        });
        };


        //this function handles all map generation stuff
        function initMap() {
            
            //defines a data structure for creating the icon that shows a user's location on the map
            const locationMarker = {
                url: "/static/img/marker.svg",
                scaledSize: new google.maps.Size(34, 34),
                origin: new google.maps.Point(0, 0),
                anchor: new google.maps.Point(0, 34),
            };


            //google maps API call that generates a map with specific center and zoom values
            var map = new google.maps.Map(document.getElementById('map2'), {
                center: { lat: 55.909329, lng: -3.319491 },
                zoom: 18,
                mapTypeId: 'satellite'
            });

            var customStyled = [{featureType: "all", elementType: "labels", stylers: [{ visibility: "off" }]}];
            //defines an initial lcoation for the location marker to go (i.e. if user location is unattainable)
            const initial = { lat: 55.909329, lng: -3.319491 };

            //generates the initial location marker 
            var marker = new google.maps.Marker({
                map,
                position: initial,
                icon: locationMarker
            });
            map.set('styles',customStyled);

            //loads the tree data from a geojson file located in the /static directory
            map.data.loadGeoJson('/static/TreesHWU.geojson', null, function (features) {

            //this function sets the style of the maps markers using the image link outlined by each object in the geojson files
            map.data.setStyle(function(feature) {
                var tree = {
                url: feature.getProperty('icon'),
                scaledSize: new google.maps.Size(64, 64),
                origin: new google.maps.Point(0, 0),
                anchor: new google.maps.Point(0, 64),
                };
             return {icon: tree};
            });

                //gets the current position of the user and pans the map to that location
                getCurrentPosition({
                    onSuccess: ({ coords: { latitude: lat, longitude: lng } }) => {
                        marker.setPosition({ lat, lng });
                        map.panTo({ lat, lng });
                    },
                    onError: err =>
                        alert(`Error: ${getPositionErrorMessage(err.code) || err.message}`)
                });

                //tracks the users current location and upda-tes the map to pan to the location on every movement, lat and long data can also
                // be sent to backend for testing (where it is added to a database)
                trackLocation({
                    onSuccess: ({ coords: { latitude: lat, longitude: lng } }) => {
                        marker.setPosition({ lat, lng });
                        map.panTo({ lat, lng });
                        /*$.ajax({
                            url: "https://www.thetrailapp.com/location/" + lat + "/" + lng
                        });*/
                    },
                    onError: err =>
                        alert(`Error: ${getPositionError(err.code) || err.message}`)
                });
            });

            // Handles click event on a tree marker, pulls matching tree data from json and renders it in a pop-up modal on screen
            map.data.addListener('click', function (event) {
                var tree_id = event.feature.getProperty('Id');
                var tree_name = event.feature.getProperty('CommonName');
                var latin_name = event.feature.getProperty('LatinName');
                var tree_age = event.feature.getProperty('Age');
                var tree_height = event.feature.getProperty('Height');
                var tree_description = event.feature.getProperty('Description');
                var tree_origin = event.feature.getProperty('Origin');
                var tree_img = event.feature.getProperty('Src');
                $('#tree_title').html(tree_id + ": " + tree_name);
                $('#tree_img').attr("src", tree_img);
                $('#tree_age').html(tree_age);
                $('#latin_name').html(latin_name);
                $('#tree_height').html(tree_height);
                $('#tree_info').html(tree_description);
                $('#tree_origin').html(tree_origin);
                $('#myModal').modal('show');
            });
        }
    </script>
  

    <!--This link performs the API call using my key and the result of the initialisation function above-->
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyALqdMIQIIw-bxjUWGb1LNwXgB8sb4saeA&callback=initMap"
        type="text/javascript">
    </script>

   
    <!-- Dynamic height adjustments to get 100% height for map-->
    <script>
        var body = document.body, html = document.documentElement;
        var height = Math.max(body.scrollHeight, body.offsetHeight, html.clientHeight, html.scrollHeight, html.offsetHeight) - 100;
        document.getElementById('map2').style.height = height + 'px';
    </script>

</body>
{{template "footer.html"}}